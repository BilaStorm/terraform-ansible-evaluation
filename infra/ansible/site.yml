---
- name: TP - deploy app locally (starter)
  hosts: local
  connection: local
  gather_facts: false

  vars:
    project_root: "../app"
    network_name: "tp_network"
    
    app_image: "tp-app:latest"
    app_container_name: "tp-app"
    app_internal_port: "5000"
    app_env: "production"
    
    proxy_container_name: "tp-proxy"
    http_port: "8080"

  tasks:
    - name: Ensure Python Docker SDK is installed (System Package)
      ansible.builtin.apt:
        name: python3-docker
        state: present
        update_cache: yes
      become: yes

    - name: Create Nginx configuration file locally
      copy:
        dest: "./nginx.conf"
        content: |
          server {
              listen 80;
              location / {
                  proxy_pass http://{{ app_container_name }}:{{ app_internal_port }};
              }
          }
    - name: Ensure Docker network exists
      community.docker.docker_network:
        name: "{{ network_name }}"
        state: present

    - name: Deploy App Container
      community.docker.docker_container:
        name: "{{ app_container_name }}"
        image: "{{ app_image }}"
        state: started
        restart_policy: on-failure
        pull: no 
        networks:
          - name: "{{ network_name }}"
        env:
          APP_ENV: "{{ app_env }}"
          PORT: "{{ app_internal_port }}"

    - name: Deploy Nginx Container (Reverse Proxy)
      community.docker.docker_container:
        name: "{{ proxy_container_name }}"
        image: nginx:alpine
        state: started
        ports:
          - "{{ http_port }}:80"
        networks:
          - name: "{{ network_name }}"
        volumes:
          - "{{ playbook_dir }}/nginx.conf:/etc/nginx/conf.d/default.conf"
        restart: "{{ 'yes' if config_file is changed else 'no' }}"
      vars:
        config_file: "{{ ansible_facts['diff'] | default({}) }}"      
    - name: Wait for service to be ready
      pause:
        seconds: 3

    - name: Verify Application Health (HTTP 200)
      uri:
        url: "http://localhost:{{ http_port }}/health"
        method: GET
        status_code: 200
        return_content: yes
      register: health_check
      until: health_check.status == 200
      retries: 5
      delay: 2

    - name: Display deployment success
      debug:
        msg: "Succès ! L'app répond : {{ health_check.json }}"